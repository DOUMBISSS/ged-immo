import { Link } from "react-router-dom";
import Sidebar from "../Components/Sidebar";
import Navbar from "./Navbar";
import { useDispatch } from "react-redux";
import { getAllHomes } from "../Redux/actions";
import { useEffect, useState } from "react";

export default function AddHome() {
  const dispatch = useDispatch();

  // --- Informations générales
  const [nameHome, setNameHome] = useState("");
  const [reference, setReference] = useState("");
  const [description, setDescription] = useState("");
  const [categorie, setCategorie] = useState("");
  const [status, setStatus] = useState("");
  const [yearBuilt, setYearBuilt] = useState("");
  const [rooms, setRooms] = useState("");
  const [floors, setFloors] = useState("");
  const [furnished, setFurnished] = useState("Non");

  // --- Localisation
  const [addressHome, setAddress] = useState("");
  const [city, setCity] = useState("");
  const [district, setDistrict] = useState("");
  const [postalCode, setPostalCode] = useState("");
  const [latitude, setLatitude] = useState("");
  const [longitude, setLongitude] = useState("");

  // --- Financier
  const [rent, setRental] = useState("");
  const [priceSale, setPriceSale] = useState("");
  const [guarantee, setGuarantee] = useState("");
  const [charges, setCharges] = useState("");
  const [tax, setTax] = useState("");
  const [minDuration, setMinDuration] = useState("");

  // --- Caractéristiques
  const [superficie, setSuperficie] = useState("");
  const [surfaceTerrain, setSurfaceTerrain] = useState("");
  const [condition, setCondition] = useState("");
  const [electricity, setElectricity] = useState("");
  const [water, setWater] = useState("");
  const [parking, setParking] = useState("");
  const [security, setSecurity] = useState("");
  const [accessibility, setAccessibility] = useState("");

  // --- Médias
  const [mainImage, setMainImage] = useState(null);
  const [uploads, setUploads] = useState([]);
  const [video, setVideo] = useState("");
  const [plan, setPlan] = useState(null);

  // --- Gestion
  const [owner, setOwner] = useState("");
  const [ownerContact, setOwnerContact] = useState("");
  const [availableDate, setAvailableDate] = useState("");

  // Charger toutes les propriétés existantes (si besoin)
  useEffect(() => {
    fetch("https://mayedo.onrender.com/homes")
      .then((res) => res.json())
      .then((rentHomes) => {
        dispatch(getAllHomes(rentHomes));
      })
      .catch((e) => console.log(e));
  }, [dispatch]);

  // Gestion des fichiers
  const handleMainImageChange = (e) => setMainImage(e.target.files[0]);
  const handleFileChange = (e) => setUploads(e.target.files);
  const handlePlanChange = (e) => setPlan(e.target.files[0]);

  // Soumission du formulaire
  const handleSubmit = (e) => {
    e.preventDefault();

    const formData = new FormData();

    // Informations générales
    formData.append("nameHome", nameHome);
    formData.append("reference", reference);
    formData.append("description", description);
    formData.append("categorie", categorie);
    formData.append("status", status);
    formData.append("yearBuilt", yearBuilt);
    formData.append("rooms", rooms);
    formData.append("floors", floors);
    formData.append("furnished", furnished);

    // Localisation
    formData.append("addressHome", addressHome);
    formData.append("city", city);
    formData.append("district", district);
    formData.append("postalCode", postalCode);
    formData.append("latitude", latitude);
    formData.append("longitude", longitude);

    // Financier
    formData.append("rent", rent);
    formData.append("priceSale", priceSale);
    formData.append("guarantee", guarantee);
    formData.append("charges", charges);
    formData.append("tax", tax);
    formData.append("minDuration", minDuration);

    // Caractéristiques
    formData.append("superficie", superficie);
    formData.append("surfaceTerrain", surfaceTerrain);
    formData.append("condition", condition);
    formData.append("electricity", electricity);
    formData.append("water", water);
    formData.append("parking", parking);
    formData.append("security", security);
    formData.append("accessibility", accessibility);

    // Médias
    if (mainImage) formData.append("mainImage", mainImage);
    Array.from(uploads).forEach((file) => {
      formData.append("uploads", file);
    });
    if (plan) formData.append("plan", plan);
    formData.append("video", video);

    // Gestion
    formData.append("owner", owner);
    formData.append("ownerContact", ownerContact);
    formData.append("availableDate", availableDate);

    fetch("http://localhost:4000/add-home", {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => console.log("Home added:", data))
      .catch((error) => console.error("Error adding home:", error));
  };

  return (
    <div>
      <Navbar />
      <div className="containers">
        <div className="dashboard">
          <div className="left">
            <Sidebar />
          </div>
          <main className="layout__content">
          <h1 className="page-title">
            <i className="fa-solid fa-house"></i> Ajouter une propriété
          </h1>

          <form onSubmit={handleSubmit} className="form">
            {/* Section Infos générales */}
            <section className="form-section">
              <h3 className="form-section__title">Informations générales</h3>
              <div className="form-row">
                <div className="form-col">
                  <label className="form-label">Nom du projet</label>
                  <input
                    type="text"
                    className="form-input"
                    value={nameHome}
                    onChange={(e) => setNameHome(e.target.value)}
                    required
                  />
                </div>
                
                <div className="form-col">
                  <label className="form-label">Nom de la propriété</label>
                  <input
                    type="text"
                    className="form-input"
                    value={nameHome}
                    onChange={(e) => setNameHome(e.target.value)}
                    required
                  />
                </div>
                <div className="form-col">
                  <label className="form-label">Référence ou N° Porte</label>
                  <input
                    type="text"
                    className="form-input"
                    value={reference}
                    onChange={(e) => setReference(e.target.value)}
                  />
                </div>
              </div>
              <label className="form-label">Description</label>
              <textarea
                className="form-input"
                value={description}
                onChange={(e) => setDescription(e.target.value)}
              />
            </section>

            {/* Section Localisation */}
            <section className="form-section">
              <h3 className="form-section__title">Localisation</h3>
              <div className="form-row">
                <div className="form-col">
                  <label className="form-label">Ville</label>
                  <input
                    type="text"
                    className="form-input"
                    value={city}
                    onChange={(e) => setCity(e.target.value)}
                  />
                </div>
                <div className="form-col">
                  <label className="form-label">Quartier</label>
                  <input
                    type="text"
                    className="form-input"
                    value={district}
                    onChange={(e) => setDistrict(e.target.value)}
                  />
                </div>
              </div>
            </section>

            {/* Section Financier */}
            <section className="form-section">
              <h3 className="form-section__title">Financier</h3>
              <div className="form-row">
                <div className="form-col">
                  <label className="form-label">Loyer mensuel</label>
                  <input
                    type="number"
                    className="form-input"
                    value={rent}
                    onChange={(e) => setRental(e.target.value)}
                  />
                </div>
                {/* <div className="form-col">
                  <label className="form-label">Prix de vente</label>
                  <input
                    type="number"
                    className="form-input"
                    value={priceSale}
                    onChange={(e) => setPriceSale(e.target.value)}
                  />
                </div> */}
                 <div className="form-col">
                  <label className="form-label">Caution X (3)</label>
                  <input
                    type="number"
                    className="form-input"
                    value={priceSale}
                    onChange={(e) => setPriceSale(e.target.value)}
                  />
                </div>
              </div>
            </section>

            {/* Section Caractéristiques */}
            {/* <section className="form-section">
              <h3 className="form-section__title">Caractéristiques</h3>
              <div className="form-row">
                <div className="form-col">
                  <label className="form-label">Superficie (m²)</label>
                  <input
                    type="number"
                    className="form-input"
                    value={superficie}
                    onChange={(e) => setSuperficie(e.target.value)}
                  />
                </div>
                <div className="form-col">
                  <label className="form-label">Surface terrain (m²)</label>
                  <input
                    type="number"
                    className="form-input"
                    value={surfaceTerrain}
                    onChange={(e) => setSurfaceTerrain(e.target.value)}
                  />
                </div>
              </div>
            </section> */}

            {/* Section Médias */}
            <section className="form-section">
              <h3 className="form-section__title">Médias</h3>
              <label className="form-label">Image principale</label>
              <input type="file" className="form-input" onChange={handleMainImageChange} />
              <label className="form-label">Galerie</label>
              <input type="file" multiple className="form-input" onChange={handleFileChange} />
            </section>

            {/* Section Gestion */}
            {/* <section className="form-section">
              <h3 className="form-section__title">Gestion</h3>
              <div className="form-row">
                <div className="form-col">
                  <label className="form-label">Nom du propriétaire</label>
                  <input
                    type="text"
                    className="form-input"
                    value={owner}
                    onChange={(e) => setOwner(e.target.value)}
                  />
                </div>
                <div className="form-col">
                  <label className="form-label">Contact propriétaire</label>
                  <input
                    type="text"
                    className="form-input"
                    value={ownerContact}
                    onChange={(e) => setOwnerContact(e.target.value)}
                  />
                </div>
              </div>
            </section> */}

             <section className="form-section">
              <h3 className="form-section__title">Observations</h3>
              <div className="form-row">
                <div className="form-col">
                  <label className="form-label">Observations particulières (cas spécifiques : “travaux prévus”) ou Notez : "RAS"</label>
              <textarea
                className="form-input"
                value={description}
                onChange={(e) => setDescription(e.target.value)}/>
                </div>
                <div className="form-col">
                  <label className="form-label">État des lieux d’entrée (texte ou fichier/photo upload)</label>
              <textarea
                className="form-input"
                value={description}
                onChange={(e) => setDescription(e.target.value)}/>
                </div>
              </div>
            </section>

            <button type="submit" className="btn-primary">
              Enregistrer
            </button>
          </form>
        </main>
        </div>
      </div>
    </div>
  );
}

est-ce possible d'associer la création du projet a la meme page que la creation de la maison 


import React, { useEffect, useState, useRef } from "react";
import { useParams } from "react-router-dom";
import { toast } from "react-toastify";
import { useReactToPrint } from "react-to-print";
import Navbar from "./Navbar";
import Footer from "../Pages/Footer";
import "react-toastify/dist/ReactToastify.css";
import EmailModal from "./Email/EmailModal";
import { useUserContext } from "../contexts/UserContext";
import { QRCodeCanvas } from "qrcode.react";

const API = "http://localhost:4000";

export default function Receipt({ admin }) {
  const { rentId } = useParams();
  const { user } = useUserContext();
  const token = user?.token;

  const [person, setPerson] = useState(null);
  const [rental, setRental] = useState(null);
  const [adminSignature, setAdminSignature] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [sendingEmail, setSendingEmail] = useState(false);

  const [signatures, setSignatures] = useState([]);
  const [selectedSignature, setSelectedSignature] = useState(null);

  const canvasRef = useRef(null);
  const isDrawing = useRef(false);
  const lastPos = useRef({ x: 0, y: 0 });
  const componentRef = useRef();

  const handlePrint = useReactToPrint({
    content: () => componentRef.current,
    documentTitle: person ? `${person.name} ${person.prenom} - Reçu` : "Reçu",
  });

  // 🔹 Récupération complète locataire et son logement
  const fetchPersonData = async (id) => {
    try {
      const res = await fetch(`${API}/detail/locataire/${id}`);
      if (!res.ok) throw new Error("Erreur récupération locataire");

      const text = await res.text();
      const data = text ? JSON.parse(text) : { home_id: [], rentals: [] };
      setPerson(data);
    } catch (e) {
      console.error("Erreur fetchPersonData:", e);
      toast.error("Impossible de récupérer les données du locataire");
    }
  };

  // 🔹 Récupération du paiement + locataire
  useEffect(() => {
    const fetchRental = async () => {
      setLoading(true);
      setError(null);
      try {
        const res = await fetch(`${API}/rents/receipt/${rentId}`);
        if (!res.ok) throw new Error("Impossible de récupérer les données.");
        const data = await res.json();

        setRental(data.rental || data);
        setPerson(data.person || null);

        // ⚡ Récupérer aussi les infos complètes du locataire (loyer inclus)
        if (data.person?._id) {
          await fetchPersonData(data.person._id);
        }

        if (data.rental?.adminId) {
          const sigRes = await fetch(`${API}/admin/${data.rental.adminId}/signature`);
          if (sigRes.ok) {
            const sigData = await sigRes.json();
            setAdminSignature(sigData.signature || null);
          }
        }
      } catch (err) {
        console.error(err);
        setError(err.message);
        toast.error("Erreur lors de la récupération du reçu.");
      } finally {
        setLoading(false);
      }
    };
    fetchRental();
  }, [rentId]);

  // --- Charger les signatures de l’admin depuis le backend ---
  useEffect(() => {
    const fetchAdminSignatures = async () => {
      if (!user?._id) return;

      try {
        const res = await fetch(`${API}/${user._id}/signatures`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        if (!res.ok) throw new Error("Impossible de récupérer les signatures admin");
        const data = await res.json();
        const sigArray = Array.isArray(data.signatures) ? data.signatures : [];

        setSignatures(sigArray);
        setSelectedSignature(sigArray[0] || null);
      } catch (err) {
        console.error("Erreur fetchAdminSignatures:", err);
        toast.error("Impossible de charger les signatures de l'admin.");
      }
    };

    fetchAdminSignatures();
  }, [user, token]);

  // ✍️ Gestion du canvas pour signature
  const getPos = (e) => {
    const rect = canvasRef.current.getBoundingClientRect();
    if (e.touches) {
      return {
        x: e.touches[0].clientX - rect.left,
        y: e.touches[0].clientY - rect.top,
      };
    }
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
  };
  const startDrawing = (e) => {
    isDrawing.current = true;
    lastPos.current = getPos(e);
  };
  const stopDrawing = () => {
    isDrawing.current = false;
    const ctx = canvasRef.current.getContext("2d");
    ctx.beginPath();
  };
  const draw = (e) => {
    if (!isDrawing.current) return;
    const ctx = canvasRef.current.getContext("2d");
    const pos = getPos(e);

    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";

    ctx.beginPath();
    ctx.moveTo(lastPos.current.x, lastPos.current.y);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();

    lastPos.current = pos;
  };
  const handleResetCanvas = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  };

  // ✅ Gestion signatures locales avec limite à 3
  // --- Ajouter une signature depuis le canvas ---
  const handleSaveSignature = async () => {
    if (signatures.length >= 3) {
      return toast.error("Vous ne pouvez enregistrer que 3 signatures maximum.");
    }

    const canvas = canvasRef.current;
    if (!canvas) return;

    const dataUrl = canvas.toDataURL("image/png");
    const blob = await (await fetch(dataUrl)).blob();
    const formData = new FormData();
    formData.append("signature", blob, "signature.png");

    try {
      const res = await fetch(`${API}/${user._id}/upload-signature`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
        },
        body: formData,
      });

      if (!res.ok) {
        const errData = await res.json();
        throw new Error(errData.message || "Erreur lors de l'envoi de la signature");
      }

      const updated = await res.json();
      setSignatures(updated.signatures);
      setSelectedSignature(updated.signatures[updated.signatures.length - 1]);
      toast.success("Signature ajoutée ✅");
    } catch (err) {
      console.error("Erreur handleSaveSignature:", err);
      toast.error(err.message);
    }
  };

  // --- Supprimer une signature ---
  const handleDeleteSignature = async (index) => {
    const sigToDelete = signatures[index];
    if (!sigToDelete) return;

    try {
      const res = await fetch(`${API}/admin/${user._id}/delete-signature`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ url: sigToDelete }),
      });

      if (!res.ok) throw new Error("Impossible de supprimer la signature");

      const updated = signatures.filter((_, i) => i !== index);
      setSignatures(updated);
      if (selectedSignature === sigToDelete) setSelectedSignature(null);
      toast.success("Signature supprimée ✅");
    } catch (err) {
      console.error("Erreur handleDeleteSignature:", err);
      toast.error("Erreur lors de la suppression de la signature");
    }
  };

  // --- Drag & drop ---
  const handleDragStart = (e, index) => e.dataTransfer.setData("dragIndex", index);
  const handleDrop = (e, dropIndex) => {
    const dragIndex = e.dataTransfer.getData("dragIndex");
    if (dragIndex === null) return;

    const updated = [...signatures];
    const [moved] = updated.splice(dragIndex, 1);
    updated.splice(dropIndex, 0, moved);
    setSignatures(updated);
  };

  if (loading)
    return (
      <div style={{ textAlign: "center", marginTop: 50 }}>
        <div className="spinner" />
        <p>Chargement du reçu...</p>
      </div>
    );
  if (error) return <p style={{ textAlign: "center", color: "red" }}>{error}</p>;
  if (!person || !rental) return <p style={{ textAlign: "center" }}>Aucune donnée disponible</p>;

  const formatCurrency = (amount) => Number(amount || 0).toLocaleString("fr-FR") + " FCFA";
  const formatDate = (dateStr) => (dateStr ? new Date(dateStr).toLocaleDateString("fr-FR") : "N/A");
  const formatMonth = (dateStr) =>
    dateStr
      ? new Date(dateStr).toLocaleDateString("fr-FR", { month: "long", year: "numeric" })
      : "N/A";

  const home = person.homeId || {};

  const handleSendWhatsapp = async ({
    rentIdParam = rentId,
    personParam = person,
    adminParam = user,
    apiBase = API,
    defaultCountryCode = "+225",
    openInNewTab = true,
  } = {}) => {
    try {
      if (!rentIdParam) return toast.error("ID du reçu manquant.");
      if (!personParam) return toast.error("Données du locataire manquantes.");

      const normalizePhone = (raw, defaultCC = "+225") => {
        if (!raw) return "";
        let digits = (raw + "").trim().replace(/\D/g, "");
        if (digits.startsWith("00")) digits = digits.replace(/^00/, "");
        const defaultDigits = defaultCC.replace(/\D/g, "");
        if (/^0/.test(digits)) digits = defaultDigits + digits.replace(/^0+/, "");
        if (!digits.startsWith("+")) digits = "+" + digits;
        if (digits.length > 15) digits = digits.slice(0, 15);
        return digits;
      };

      const locataireRaw = personParam.tel || personParam.number || personParam.contact || "";
      const locataireDigits = normalizePhone(locataireRaw, defaultCountryCode);
      if (!locataireDigits || locataireDigits.length < 8 || locataireDigits.length > 15) {
        return toast.error("Numéro du locataire invalide / mal formaté.");
      }

      const res = await fetch(`${apiBase}/rents/${rentIdParam}/temp-link`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (!res.ok) throw new Error("Impossible de générer le lien temporaire.");
      const { tempUrl } = await res.json();
      if (!tempUrl) throw new Error("Le serveur n'a pas retourné de tempUrl.");

      const ensureAbsoluteUrl = (u) => {
        try { return new URL(u).href; } catch (e) { return window.location.origin.replace(/\/$/, "") + "/" + u.replace(/^\//, ""); }
      };
      const finalTempUrl = ensureAbsoluteUrl(tempUrl);

      const messageLines = [
        `Bonjour ${personParam.name || personParam.nom || ""} ${personParam.prenom || ""}`.trim(),
        "",
        `Votre reçu de paiement est disponible ici :`,
        finalTempUrl,
        "",
        "Si le lien ne s'ouvre pas, copiez-collez-le dans votre navigateur."
      ];
      const message = messageLines.filter(Boolean).join("\n");
      const whatsappUrl = `https://web.whatsapp.com/send?phone=${locataireDigits.replace(/\+/g, '')}&text=${encodeURIComponent(message)}`;

      const opened = window.open(whatsappUrl, openInNewTab ? "_blank" : "_self", "noopener,noreferrer");
      if (!opened) {
        try {
          await navigator.clipboard.writeText(message);
          toast.success("Impossible d'ouvrir WhatsApp (pop-up bloqué). Le message a été copié dans le presse-papier.");
        } catch (e) {
          console.log("Temp link:", finalTempUrl);
          toast.error("Impossible d'ouvrir WhatsApp automatiquement. Lien affiché dans la console.");
        }
      } else {
        toast.success("WhatsApp ouvert — vérifiez l'onglet et cliquez sur Envoyer.");
      }
    } catch (err) {
      console.error("handleSendWhatsapp error:", err);
      toast.error(err.message || "Erreur envoi du reçu WhatsApp.");
    }
  };

  const handleSendEmail = async () => {
    try {
      if (!person) return toast.error("Données du locataire manquantes.");
      const email = Array.isArray(person) ? person[0]?.email || "" : person.email || "";
      if (!email) return toast.error("Email du locataire manquant.");

      setSendingEmail(true);

      const body = {
        person_email: email,
        rentId: rentId,
        adminName: user?.name || "",
        adminEmail: user?.email || "",
      };

      const res = await fetch(`${API}/rents/${rentId}/send-receipt`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${user?.token}` },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        const errData = await res.json();
        throw new Error(errData?.message || "Erreur lors de l'envoi du mail");
      }

      const data = await res.json();
      toast.success(data.message || "Email envoyé avec succès ✅");
    } catch (err) {
      console.error("handleSendEmail error:", err);
      toast.error(err.message || "Erreur lors de l'envoi du mail");
    } finally {
      setSendingEmail(false);
    }
  };

  return (
    <>
      <Navbar />
      <div className="receipt-xxl-container">
        <div className="receipt-xxl-card" ref={componentRef}>
          <div className="receipt-xxl-header">
            <h1>Reçu paiement N° {rental.receipt_number || rental._id}</h1>
          </div>

          <div className="container__print">
            <button className="btn__print" onClick={handlePrint}>
              <i className="fa-solid fa-print"></i> Imprimer / Télécharger PDF
            </button>
            <button onClick={handleSendEmail} className="btn__email" disabled={sendingEmail}>
              {sendingEmail ? (
                <>
                  <div className="spinner"></div> Envoi en cours...
                </>
              ) : (
                <>
                  <i className="fa-solid fa-envelope"></i> Envoyer le reçu par mail
                </>
              )}
            </button>
            <button className="btn__whatsapp" onClick={handleSendWhatsapp}>
              <i className="fa-brands fa-whatsapp"></i> Envoyer sur WhatsApp
            </button>
          </div>

          <div className="receipt-xxl-section">
            <div>
              <h5>Le propriétaire</h5>
              <p><strong>{user?.fullname || "Néant"}</strong></p>
              <p><strong>{user?.number || "Néant"}</strong></p>
              <p><strong>{user?.email || "Néant"}</strong></p>
              <p><strong>{user?.address || "Néant"}</strong></p>
            </div>
            <div>
              <h5>Le locataire</h5>
              <p><strong>Mme/M. {person.name || "N/A"} {person.prenom || ""}</strong></p>
              <p><strong>{person.tel || person.number || "N/A"}</strong></p>
              <p><strong>{person.email || "N/A"}</strong></p>
              <p><strong>{person.address || "N/A"}</strong></p>
            </div>
          </div>

          <div className="receipt-xxl-description">
            <p>Reçu de <strong>Mme/M. {person?.name || ""} {person?.lastname || ""}</strong></p>
            <p>La somme de <strong>{formatCurrency(rental?.amount || home?.rent)}</strong></p>
            <p>Le <strong>{formatDate(rental?.date_of_payment)}</strong></p>
            <p>
              Pour le loyer du/de <strong>{home?.categorie || "Logement"} {home?.NmbrePieces ? `(${home.NmbrePieces} pièces)` : ""}</strong> situé à : <strong>{home?.addressHome || "N/A"}</strong>
              {home?.quarter && <> , Quartier : <strong>{home.quarter}</strong></>}
            </p>
            {home?.rent && (
              <p>Loyer mensuel : <strong>{Number(home.rent).toLocaleString()} FCFA</strong></p>
            )}
            <p>Paiement du mois de : <strong>{formatMonth(rental?.month)}</strong></p>
            <p>Paiement par <strong>{rental?.mode || "N/A"}</strong></p>

            <div className="receipt-xxl-footer">
              <p>Fait à Abidjan le <strong>{formatDate(rental?.date_of_payment)}</strong></p>
              <p><strong>Cachet & Signature du Propriétaire</strong></p>
              {selectedSignature ? (
                <img src={selectedSignature} alt="Signature Admin" />
              ) : adminSignature ? (
                <img src={adminSignature} alt="Signature Admin" />
              ) : (
                <p>Signature non disponible</p>
              )}
            </div>
          </div>

          {/* ✅ Ajout du QR Code */}
          <div className="receipt-xxl-qr">
            <h5>Vérification du reçu</h5>
            <QRCodeCanvas value={`${API}/receipt/${rental._id}`} size={120} />
          </div>

          <div className="receipt-legal">
            <p>Ce reçu est généré électroniquement par <strong>{user?.fullname || "l'Administrateur"}</strong>.</p>
            <p>Toute falsification est passible de sanctions.</p>
          </div>
        </div>
      </div>

      {/* ✅ Section signatures */}
      {/* ✅ Section signatures */}
<div className="signature-section">
  <h2>Signature</h2>
  <canvas
    ref={canvasRef}
    width={window.innerWidth > 768 ? 600 : 300}
    height={150}
    onMouseDown={startDrawing}
    onMouseMove={draw}
    onMouseUp={stopDrawing}
    onMouseLeave={stopDrawing}
    onTouchStart={startDrawing}
    onTouchMove={draw}
    onTouchEnd={stopDrawing}
    className="signature-canvas"
    style={{ border: "1px solid #ccc", borderRadius: 5, touchAction: "none" }}
  />
  <div style={{ marginTop: 10 }}>
    <button onClick={handleSaveSignature} className="btn-save">
      Enregistrer la signature
    </button>
    <button
      onClick={handleResetCanvas}
      className="btn-save"
      style={{ backgroundColor: "#e74c3c", marginLeft: 10 }}
    >
      Réinitialiser
    </button>
  </div>

  {signatures.length > 0 && (
    <div className="signature-list">
      {signatures.map((sig, index) => (
        <div
          key={index}
          className="signature-item"
          draggable
          onDragStart={(e) => handleDragStart(e, index)}
          onDrop={(e) => handleDrop(e, index)}
          onDragOver={(e) => e.preventDefault()}
          style={{
            display: "inline-block",
            margin: 5,
            cursor: "grab",
            border: selectedSignature === sig ? "2px solid #4b00cc" : "1px solid #ccc",
            padding: 3,
            borderRadius: 5,
          }}
        >
          <img
            src={sig}
            alt={`Signature ${index + 1}`}
            style={{ width: 100, height: 50, objectFit: "contain" }}
          />
          <button
            onClick={() => setSelectedSignature(sig)}
            style={{
              display: "block",
              marginTop: 3,
              width: "100%",
              background: "#4b00cc",
              color: "#fff",
              border: "none",
              borderRadius: 3,
              cursor: "pointer",
            }}
          >
            Sélectionner
          </button>
          <button
            onClick={() => handleDeleteSignature(index)}
            style={{
              display: "block",
              marginTop: 3,
              width: "100%",
              background: "#e74c3c",
              color: "#fff",
              border: "none",
              borderRadius: 3,
              cursor: "pointer",
            }}
          >
            Supprimer
          </button>
        </div>
      ))}
    </div>
  )}
</div>

      <Footer />
      <EmailModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} rentId={rentId} adminEmail={admin?.email || ""} tenantEmail={person?.email || ""} />

      <style>{`
        .spinner { border: 6px solid #f3f3f3; border-top: 6px solid #4b00cc; border-radius: 50%; width: 40px; height: 40px; margin: 0 auto 1rem auto; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg); } }
        .receipt-xxl-container { display: flex; justify-content: center; padding: 3rem; background: linear-gradient(135deg, #f5f7fa, #e6e9f0); min-height: 100vh; }
        .receipt-xxl-card { background: #fff; width: 950px; padding: 2.5rem 3rem; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); font-family: 'Montserrat', sans-serif; color: #2c3e50; line-height: 1.8;position: relative; }
        .receipt-xxl-card::before { content: ""; position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%) rotate(0deg); width: 400px; height: 400px; background-image: url('/logo4 copie.jpg'); background-size: contain; background-repeat: no-repeat; background-position: center; opacity: 0.1; z-index: 0; pointer-events: none; }
        .receipt-xxl-header { text-align: center; margin-bottom: 2rem; }
        .receipt-xxl-header h1 { font-size: 2.5rem; color: #4b00cc; margin: 0; }
        .receipt-xxl-section { display: flex; justify-content: space-between; margin-bottom: 2rem; }
        .receipt-xxl-section div { width: 48%; background: #fafafa; padding: 1rem; border-radius: 10px; border: 1px solid #eee; }
        .receipt-xxl-section h5 { color: #4b00cc; margin-bottom: 0.8rem; font-size: 1.1rem; border-bottom: 2px solid #eee; padding-bottom: 0.3rem; }
        .receipt-xxl-description { background: #fdfdfd; padding: 1.5rem; border-radius: 10px; border: 1px solid #ddd; }
        .receipt-xxl-description p { margin: 0.7rem 0; font-size: 1rem; }
        .receipt-xxl-description strong { color: #000; }
        .receipt-xxl-footer { margin-top: 3rem; display: flex; flex-direction: column; align-items: flex-end; text-align: right; }
        .receipt-xxl-footer img { margin-top: 1rem; max-width: 200px; }
        .btn__print, .btn__email, .btn__whatsapp { padding: 0.7rem 1.5rem; border: none; font-weight: bold; border-radius: 8px; cursor: pointer; margin: 0 0.5rem 2rem 0; transition: 0.3s; }
        .btn__print { background-color: #4b00cc; color: #fff; }
        .btn__print:hover { background-color: #3a0080; }
        .btn__email { background-color: #007bff; color: #fff; }
        .btn__email:hover { background-color: #0056b3; }
        .btn__whatsapp { background-color: #25D366; color: #fff; }
        .btn__whatsapp:hover { background-color: #128C7E; }
        .container__print { display: flex; justify-content: center; margin-bottom: 1rem; }
        .signature-section { margin: 2rem 0; text-align: center; }
        .btn-save { margin-top: 1rem; padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; background-color: #4b00cc; color: #fff; font-weight: bold; }
        .btn-save:hover { background-color: #3a0080; }
        .signature-list { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 1rem; }
        @media print {
          .btn__print, .btn__email, .btn__whatsapp, nav, footer, .breadcrumb, .signature-section { display: none !important; }
          .receipt-xxl-card { box-shadow: none; width: 100%; padding: 1rem }
        }
        .receipt-legal { margin-top: 2rem; text-align: center; font-size: 0.8rem; color: #777; border-top: 1px dashed #ccc; padding-top: 0.5rem; }
        .receipt-xxl-qr { margin-top: 2rem; text-align: center; }
        .receipt-xxl-qr h5 { color: #4b00cc; margin-bottom: 0.5rem; }
      `}</style>
    </>
  );
}



import React, { useEffect, useState, useRef } from "react";
import { useParams } from "react-router-dom";
import { toast } from "react-toastify";
import { useReactToPrint } from "react-to-print";
import Navbar from "./Navbar";
import Footer from "../Pages/Footer";
import "react-toastify/dist/ReactToastify.css";
import EmailModal from "./Email/EmailModal";
import { useUserContext } from "../contexts/UserContext";
import { QRCodeCanvas } from "qrcode.react";

const API = "http://localhost:4000";

export default function Receipt({ admin }) {
  const { rentId } = useParams();
  const { user } = useUserContext();
  const token = user?.token;

  const [person, setPerson] = useState(null);
  const [rental, setRental] = useState(null);
  const [adminSignature, setAdminSignature] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [sendingEmail, setSendingEmail] = useState(false);

  const [signatures, setSignatures] = useState(
    JSON.parse(localStorage.getItem("admin_signatures") || "[]")
  );
  const [selectedSignature, setSelectedSignature] = useState(null);

  const canvasRef = useRef(null);
  const isDrawing = useRef(false);
  const lastPos = useRef({ x: 0, y: 0 });
  const componentRef = useRef();

  const handlePrint = useReactToPrint({
    content: () => componentRef.current,
    documentTitle: person ? `${person.name} ${person.prenom} - Reçu` : "Reçu",
  });

  // 🔹 Récupération complète locataire et son logement
  const fetchPersonData = async (id) => {
    try {
      const res = await fetch(`${API}/detail/locataire/${id}`);
      if (!res.ok) throw new Error("Erreur récupération locataire");

      const text = await res.text();
      const data = text ? JSON.parse(text) : { home_id: [], rentals: [] };
      setPerson(data);
    } catch (e) {
      console.error("Erreur fetchPersonData:", e);
      toast.error("Impossible de récupérer les données du locataire");
    }
  };

  // 🔹 Récupération du paiement + locataire
  useEffect(() => {
    const fetchRental = async () => {
      setLoading(true);
      setError(null);
      try {
        const res = await fetch(`${API}/rents/receipt/${rentId}`);
        if (!res.ok) throw new Error("Impossible de récupérer les données.");
        const data = await res.json();

        setRental(data.rental || data);
        setPerson(data.person || null);

        // ⚡ Récupérer aussi les infos complètes du locataire (loyer inclus)
        if (data.person?._id) {
          await fetchPersonData(data.person._id);
        }

        if (data.rental?.adminId) {
          const sigRes = await fetch(`${API}/admin/${data.rental.adminId}/signature`);
          if (sigRes.ok) {
            const sigData = await sigRes.json();
            setAdminSignature(sigData.signature || null);
          }
        }
      } catch (err) {
        console.error(err);
        setError(err.message);
        toast.error("Erreur lors de la récupération du reçu.");
      } finally {
        setLoading(false);
      }
    };
    fetchRental();
  }, [rentId]);

  // --- Charger les signatures de l’admin depuis le backend ---
  useEffect(() => {
    const fetchAdminSignatures = async () => {
      if (!user?._id) return;

      try {
        const res = await fetch(`${API}/${user._id}/signatures`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        if (!res.ok) throw new Error("Impossible de récupérer les signatures admin");
        const data = await res.json();
        const sigArray = Array.isArray(data.signatures) ? data.signatures : [];

        setSignatures(sigArray);
        setSelectedSignature(sigArray[0] || null);
      } catch (err) {
        console.error("Erreur fetchAdminSignatures:", err);
        toast.error("Impossible de charger les signatures de l'admin.");
      }
    };

    fetchAdminSignatures();
  }, [user, token]);

  // ✍️ Gestion du canvas pour signature
  const getPos = (e) => {
    const rect = canvasRef.current.getBoundingClientRect();
    if (e.touches) {
      return {
        x: e.touches[0].clientX - rect.left,
        y: e.touches[0].clientY - rect.top,
      };
    }
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
  };
  const startDrawing = (e) => {
    isDrawing.current = true;
    lastPos.current = getPos(e);
  };
  const stopDrawing = () => {
    isDrawing.current = false;
    const ctx = canvasRef.current.getContext("2d");
    ctx.beginPath();
  };
  const draw = (e) => {
    if (!isDrawing.current) return;
    const ctx = canvasRef.current.getContext("2d");
    const pos = getPos(e);

    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";

    ctx.beginPath();
    ctx.moveTo(lastPos.current.x, lastPos.current.y);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();

    lastPos.current = pos;
  };
  const handleResetCanvas = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  };

  // ✅ Gestion signatures locales avec limite à 3
  // --- Ajouter une signature depuis le canvas ---
  const handleSaveSignature = async () => {
    if (signatures.length >= 3) {
      return toast.error("Vous ne pouvez enregistrer que 3 signatures maximum.");
    }

    const canvas = canvasRef.current;
    if (!canvas) return;

    const dataUrl = canvas.toDataURL("image/png");
    const blob = await (await fetch(dataUrl)).blob();
    const formData = new FormData();
    formData.append("signature", blob, "signature.png");

    try {
      const res = await fetch(`${API}/${user._id}/upload-signature`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
        },
        body: formData,
      });

      if (!res.ok) {
        const errData = await res.json();
        throw new Error(errData.message || "Erreur lors de l'envoi de la signature");
      }

      const updated = await res.json();
      setSignatures(updated.signatures);
      setSelectedSignature(updated.signatures[updated.signatures.length - 1]);
      toast.success("Signature ajoutée ✅");
    } catch (err) {
      console.error("Erreur handleSaveSignature:", err);
      toast.error(err.message);
    }
  };

  // --- Supprimer une signature ---
  const handleDeleteSignature = async (index) => {
    const sigToDelete = signatures[index];
    if (!sigToDelete) return;

    try {
      const res = await fetch(`${API}/admin/${user._id}/delete-signature`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ url: sigToDelete }),
      });

      if (!res.ok) throw new Error("Impossible de supprimer la signature");

      const updated = signatures.filter((_, i) => i !== index);
      setSignatures(updated);
      if (selectedSignature === sigToDelete) setSelectedSignature(null);
      toast.success("Signature supprimée ✅");
    } catch (err) {
      console.error("Erreur handleDeleteSignature:", err);
      toast.error("Erreur lors de la suppression de la signature");
    }
  };

  // --- Drag & drop ---
  const handleDragStart = (e, index) => e.dataTransfer.setData("dragIndex", index);
  const handleDrop = (e, dropIndex) => {
    const dragIndex = e.dataTransfer.getData("dragIndex");
    if (dragIndex === null) return;

    const updated = [...signatures];
    const [moved] = updated.splice(dragIndex, 1);
    updated.splice(dropIndex, 0, moved);
    setSignatures(updated);
  };

  if (loading)
    return (
      <div style={{ textAlign: "center", marginTop: 50 }}>
        <div className="spinner" />
        <p>Chargement du reçu...</p>
      </div>
    );
  if (error) return <p style={{ textAlign: "center", color: "red" }}>{error}</p>;
  if (!person || !rental) return <p style={{ textAlign: "center" }}>Aucune donnée disponible</p>;

  const formatCurrency = (amount) => Number(amount || 0).toLocaleString("fr-FR") + " FCFA";
  const formatDate = (dateStr) => (dateStr ? new Date(dateStr).toLocaleDateString("fr-FR") : "N/A");
  const formatMonth = (dateStr) =>
    dateStr
      ? new Date(dateStr).toLocaleDateString("fr-FR", { month: "long", year: "numeric" })
      : "N/A";

  const home = person.homeId || {};

  const handleSendWhatsapp = async ({
    rentIdParam = rentId,
    personParam = person,
    adminParam = user,
    apiBase = API,
    defaultCountryCode = "+225",
    openInNewTab = true,
  } = {}) => {
    try {
      if (!rentIdParam) return toast.error("ID du reçu manquant.");
      if (!personParam) return toast.error("Données du locataire manquantes.");

      const normalizePhone = (raw, defaultCC = "+225") => {
        if (!raw) return "";
        let digits = (raw + "").trim().replace(/\D/g, "");
        if (digits.startsWith("00")) digits = digits.replace(/^00/, "");
        const defaultDigits = defaultCC.replace(/\D/g, "");
        if (/^0/.test(digits)) digits = defaultDigits + digits.replace(/^0+/, "");
        if (!digits.startsWith("+")) digits = "+" + digits;
        if (digits.length > 15) digits = digits.slice(0, 15);
        return digits;
      };

      const locataireRaw = personParam.tel || personParam.number || personParam.contact || "";
      const locataireDigits = normalizePhone(locataireRaw, defaultCountryCode);
      if (!locataireDigits || locataireDigits.length < 8 || locataireDigits.length > 15) {
        return toast.error("Numéro du locataire invalide / mal formaté.");
      }

      const res = await fetch(`${apiBase}/rents/${rentIdParam}/temp-link`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (!res.ok) throw new Error("Impossible de générer le lien temporaire.");
      const { tempUrl } = await res.json();
      if (!tempUrl) throw new Error("Le serveur n'a pas retourné de tempUrl.");

      const ensureAbsoluteUrl = (u) => {
        try { return new URL(u).href; } catch (e) { return window.location.origin.replace(/\/$/, "") + "/" + u.replace(/^\//, ""); }
      };
      const finalTempUrl = ensureAbsoluteUrl(tempUrl);

      const messageLines = [
        `Bonjour ${personParam.name || personParam.nom || ""} ${personParam.prenom || ""}`.trim(),
        "",
        `Votre reçu de paiement est disponible ici :`,
        finalTempUrl,
        "",
        "Si le lien ne s'ouvre pas, copiez-collez-le dans votre navigateur."
      ];
      const message = messageLines.filter(Boolean).join("\n");
      const whatsappUrl = `https://web.whatsapp.com/send?phone=${locataireDigits.replace(/\+/g, '')}&text=${encodeURIComponent(message)}`;

      const opened = window.open(whatsappUrl, openInNewTab ? "_blank" : "_self", "noopener,noreferrer");
      if (!opened) {
        try {
          await navigator.clipboard.writeText(message);
          toast.success("Impossible d'ouvrir WhatsApp (pop-up bloqué). Le message a été copié dans le presse-papier.");
        } catch (e) {
          console.log("Temp link:", finalTempUrl);
          toast.error("Impossible d'ouvrir WhatsApp automatiquement. Lien affiché dans la console.");
        }
      } else {
        toast.success("WhatsApp ouvert — vérifiez l'onglet et cliquez sur Envoyer.");
      }
    } catch (err) {
      console.error("handleSendWhatsapp error:", err);
      toast.error(err.message || "Erreur envoi du reçu WhatsApp.");
    }
  };

  const handleSendEmail = async () => {
    try {
      if (!person) return toast.error("Données du locataire manquantes.");
      const email = Array.isArray(person) ? person[0]?.email || "" : person.email || "";
      if (!email) return toast.error("Email du locataire manquant.");

      setSendingEmail(true);

      const body = {
        person_email: email,
        rentId: rentId,
        adminName: user?.name || "",
        adminEmail: user?.email || "",
      };

      const res = await fetch(`${API}/rents/${rentId}/send-receipt`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${user?.token}` },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        const errData = await res.json();
        throw new Error(errData?.message || "Erreur lors de l'envoi du mail");
      }

      const data = await res.json();
      toast.success(data.message || "Email envoyé avec succès ✅");
    } catch (err) {
      console.error("handleSendEmail error:", err);
      toast.error(err.message || "Erreur lors de l'envoi du mail");
    } finally {
      setSendingEmail(false);
    }
  };

  return (
    <>
      <Navbar />
      <div className="receipt-xxl-container">
        <div className="receipt-xxl-card" ref={componentRef}>
          <div className="receipt-xxl-header">
            <h1>Reçu paiement N° {rental.receipt_number || rental._id}</h1>
          </div>

          <div className="container__print">
            <button className="btn__print" onClick={handlePrint}>
              <i className="fa-solid fa-print"></i> Imprimer / Télécharger PDF
            </button>
            <button onClick={handleSendEmail} className="btn__email" disabled={sendingEmail}>
              {sendingEmail ? (
                <>
                  <div className="spinner"></div> Envoi en cours...
                </>
              ) : (
                <>
                  <i className="fa-solid fa-envelope"></i> Envoyer le reçu par mail
                </>
              )}
            </button>
            <button className="btn__whatsapp" onClick={handleSendWhatsapp}>
              <i className="fa-brands fa-whatsapp"></i> Envoyer sur WhatsApp
            </button>
          </div>

          <div className="receipt-xxl-section">
            <div>
              <h5>Le propriétaire</h5>
              <p><strong>{user?.fullname || "Néant"}</strong></p>
              <p><strong>{user?.number || "Néant"}</strong></p>
              <p><strong>{user?.email || "Néant"}</strong></p>
              <p><strong>{user?.address || "Néant"}</strong></p>
            </div>
            <div>
              <h5>Le locataire</h5>
              <p><strong>Mme/M. {person.name || "N/A"} {person.prenom || ""}</strong></p>
              <p><strong>{person.tel || person.number || "N/A"}</strong></p>
              <p><strong>{person.email || "N/A"}</strong></p>
              <p><strong>{person.address || "N/A"}</strong></p>
            </div>
          </div>

          <div className="receipt-xxl-description">
            <p>Reçu de <strong>Mme/M. {person?.name || ""} {person?.lastname || ""}</strong></p>
            <p>La somme de <strong>{formatCurrency(rental?.amount || home?.rent)}</strong></p>
            <p>Le <strong>{formatDate(rental?.date_of_payment)}</strong></p>
            <p>
              Pour le loyer du/de <strong>{home?.categorie || "Logement"} {home?.NmbrePieces ? `(${home.NmbrePieces} pièces)` : ""}</strong> situé à : <strong>{home?.addressHome || "N/A"}</strong>
              {home?.quarter && <> , Quartier : <strong>{home.quarter}</strong></>}
            </p>
            {home?.rent && (
              <p>Loyer mensuel : <strong>{Number(home.rent).toLocaleString()} FCFA</strong></p>
            )}
            <p>Paiement du mois de : <strong>{formatMonth(rental?.month)}</strong></p>
            <p>Paiement par <strong>{rental?.mode || "N/A"}</strong></p>

            <div className="receipt-xxl-footer">
              <p>Fait à Abidjan le <strong>{formatDate(rental?.date_of_payment)}</strong></p>
              <p><strong>Cachet & Signature du Propriétaire</strong></p>
              {selectedSignature ? (
                <img src={selectedSignature} alt="Signature Admin" />
              ) : adminSignature ? (
                <img src={adminSignature} alt="Signature Admin" />
              ) : (
                <p>Signature non disponible</p>
              )}
            </div>
          </div>

          {/* ✅ Ajout du QR Code */}
          <div className="receipt-xxl-qr">
            <h5>Vérification du reçu</h5>
            <QRCodeCanvas value={`${API}/receipt/${rental._id}`} size={120} />
          </div>

          <div className="receipt-legal">
            <p>Ce reçu est généré électroniquement par <strong>{user?.fullname || "l'Administrateur"}</strong>.</p>
            <p>Toute falsification est passible de sanctions.</p>
          </div>
        </div>
      </div>

      {/* ✅ Section signatures */}
      <div className="signature-section">
        <h2>Signature</h2>
        <canvas
          ref={canvasRef}
          width={window.innerWidth > 768 ? 600 : 300}
          height={150}
          onMouseDown={startDrawing}
          onMouseMove={draw}
          onMouseUp={stopDrawing}
          onMouseLeave={stopDrawing}
          onTouchStart={startDrawing}
          onTouchMove={draw}
          onTouchEnd={stopDrawing}
          className="signature-canvas"
          style={{ border: "1px solid #ccc", borderRadius: 5, touchAction: "none" }}
        />
        <div style={{ marginTop: 10 }}>
          <button onClick={handleSaveSignature} className="btn-save">Enregistrer la signature</button>
          <button onClick={handleResetCanvas} className="btn-save" style={{ backgroundColor: "#e74c3c", marginLeft: 10 }}>Réinitialiser</button>
        </div>

        {signatures.length > 0 && (
          <div className="signature-list">
            {signatures.map((sig, index) => (
              <div
                key={index}
                className="signature-item"
                draggable
                onDragStart={(e) => handleDragStart(e, index)}
                onDrop={(e) => handleDrop(e, index)}
                onDragOver={(e) => e.preventDefault()}
                style={{
                  display: "inline-block",
                  margin: 5,
                  cursor: "grab",
                  border: selectedSignature === sig ? "2px solid #4b00cc" : "1px solid #ccc",
                  padding: 3,
                  borderRadius: 5,
                }}
              >
                <img src={sig} alt={`Signature ${index + 1}`} style={{ width: 100, height: 50, objectFit: "contain" }} />
                <button
                  onClick={() => setSelectedSignature(sig)}
                  style={{ display: "block", marginTop: 3, width: "100%", background: "#4b00cc", color: "#fff", border: "none", borderRadius: 3, cursor: "pointer" }}
                >
                  Sélectionner
                </button>
                <button
                  onClick={() => handleDeleteSignature(index)}
                  style={{ display: "block", marginTop: 3, width: "100%", background: "#e74c3c", color: "#fff", border: "none", borderRadius: 3, cursor: "pointer" }}
                >
                  Supprimer
                </button>
              </div>
            ))}
          </div>
        )}
      </div>

      <Footer />
      <EmailModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} rentId={rentId} adminEmail={admin?.email || ""} tenantEmail={person?.email || ""} />

      <style>{`
        .spinner { border: 6px solid #f3f3f3; border-top: 6px solid #4b00cc; border-radius: 50%; width: 40px; height: 40px; margin: 0 auto 1rem auto; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg); } }
        .receipt-xxl-container { display: flex; justify-content: center; padding: 3rem; background: linear-gradient(135deg, #f5f7fa, #e6e9f0); min-height: 100vh; }
        .receipt-xxl-card { background: #fff; width: 950px; padding: 2.5rem 3rem; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); font-family: 'Montserrat', sans-serif; color: #2c3e50; line-height: 1.8;position: relative; }
        .receipt-xxl-card::before { content: ""; position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%) rotate(0deg); width: 400px; height: 400px; background-image: url('/logo4 copie.jpg'); background-size: contain; background-repeat: no-repeat; background-position: center; opacity: 0.1; z-index: 0; pointer-events: none; }
        .receipt-xxl-header { text-align: center; margin-bottom: 2rem; }
        .receipt-xxl-header h1 { font-size: 2.5rem; color: #4b00cc; margin: 0; }
        .receipt-xxl-section { display: flex; justify-content: space-between; margin-bottom: 2rem; }
        .receipt-xxl-section div { width: 48%; background: #fafafa; padding: 1rem; border-radius: 10px; border: 1px solid #eee; }
        .receipt-xxl-section h5 { color: #4b00cc; margin-bottom: 0.8rem; font-size: 1.1rem; border-bottom: 2px solid #eee; padding-bottom: 0.3rem; }
        .receipt-xxl-description { background: #fdfdfd; padding: 1.5rem; border-radius: 10px; border: 1px solid #ddd; }
        .receipt-xxl-description p { margin: 0.7rem 0; font-size: 1rem; }
        .receipt-xxl-description strong { color: #000; }
        .receipt-xxl-footer { margin-top: 3rem; display: flex; flex-direction: column; align-items: flex-end; text-align: right; }
        .receipt-xxl-footer img { margin-top: 1rem; max-width: 200px; }
        .btn__print, .btn__email, .btn__whatsapp { padding: 0.7rem 1.5rem; border: none; font-weight: bold; border-radius: 8px; cursor: pointer; margin: 0 0.5rem 2rem 0; transition: 0.3s; }
        .btn__print { background-color: #4b00cc; color: #fff; }
        .btn__print:hover { background-color: #3a0080; }
        .btn__email { background-color: #007bff; color: #fff; }
        .btn__email:hover { background-color: #0056b3; }
        .btn__whatsapp { background-color: #25D366; color: #fff; }
        .btn__whatsapp:hover { background-color: #128C7E; }
        .container__print { display: flex; justify-content: center; margin-bottom: 1rem; }
        .signature-section { margin: 2rem 0; text-align: center; }
        .btn-save { margin-top: 1rem; padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; background-color: #4b00cc; color: #fff; font-weight: bold; }
        .btn-save:hover { background-color: #3a0080; }
        .signature-list { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 1rem; }
        @media print {
          .btn__print, .btn__email, .btn__whatsapp, nav, footer, .breadcrumb, .signature-section { display: none !important; }
          .receipt-xxl-card { box-shadow: none; width: 100%; padding: 1rem }
        }
        .receipt-legal { margin-top: 2rem; text-align: center; font-size: 0.8rem; color: #777; border-top: 1px dashed #ccc; padding-top: 0.5rem; }
        .receipt-xxl-qr { margin-top: 2rem; text-align: center; }
        .receipt-xxl-qr h5 { color: #4b00cc; margin-bottom: 0.5rem; }
      `}</style>
    </>
  );
}


import { Link } from "react-router-dom";
import Navbar from "./Navbar";
import Footer from "./Footer";
import { useState, useEffect, useMemo } from "react";
import { Blocks } from "react-loader-spinner";
import toast, { Toaster } from "react-hot-toast";
import { useUserContext } from "../contexts/UserContext";
import PermissionModal from "./PermissionModal";

export default function Archives() {
  const { user } = useUserContext();
  const [persons, setPersons] = useState([]);
  const [homes, setHomes] = useState([]); // 🏠 maisons archivées
  const [projects, setProjects] = useState([]);
  const [searchProject, setSearchProject] = useState(() => localStorage.getItem("archiveSearchProject") || "");
  const [searchTerm, setSearchTerm] = useState(() => localStorage.getItem("archiveSearchTerm") || "");
  const [currentPage, setCurrentPage] = useState(() => parseInt(localStorage.getItem("archiveCurrentPage")) || 1);
  const [loading, setLoading] = useState(false);
  const [showPermissionModal, setShowPermissionModal] = useState(false);

  const itemsPerPage = 15;

  // 🔹 Sauvegarde localStorage
  useEffect(() => { localStorage.setItem("archiveSearchProject", searchProject); }, [searchProject]);
  useEffect(() => { localStorage.setItem("archiveSearchTerm", searchTerm); }, [searchTerm]);
  useEffect(() => { localStorage.setItem("archiveCurrentPage", currentPage); }, [currentPage]);

  useEffect(() => {
    if (!user) return;
    const hasPermission = user.role === "admin" || (user.permissions?.includes("view_archives"));
    if (!hasPermission) {
      setShowPermissionModal(true);
      toast.error("Vous n'êtes pas autorisé à accéder aux archives.");
    }
  }, [user]);

  // 🔹 Récupérer projets + locataires archivés
  useEffect(() => {
    if (!user?._id || !user?.token) return;
    const adminIdToFetch = user.role === "admin" ? user._id : user.adminId;
    if (!adminIdToFetch) return toast.error("Aucun administrateur lié.");

    const fetchData = async () => {
      try {
        setLoading(true);

        // 🔸 1. Locataires archivés
        const res1 = await fetch(`http://localhost:4000/archives/admin/${adminIdToFetch}`, {
          headers: { Authorization: `Bearer ${user.token}` },
        });
        const data1 = await res1.json();

        if (data1.success) {
          setProjects(data1.projects || []);
          setPersons(data1.locataireArchives || data1.archives || []);
        } else toast.error(data1.message || "Erreur récupération locataires archivés");

        // 🔸 2. Maisons archivées
        const res2 = await fetch(`http://localhost:4000/homes/archives/${adminIdToFetch}`, {
          headers: { Authorization: `Bearer ${user.token}` },
        });
        const data2 = await res2.json();

        if (data2.success) {
          setHomes(data2.archivedHomes || []);
        } else toast.error(data2.message || "Erreur récupération maisons archivées");

      } catch (err) {
        toast.error("Erreur chargement archives : " + err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [user]);

  // 🔹 Filtrage locataires
  const filteredPersons = useMemo(() => {
    return searchTerm
      ? persons.filter(p =>
          `${p.personId?.name || ""} ${p.personId?.lastname || ""}`.toLowerCase().includes(searchTerm.toLowerCase())
        )
      : persons;
  }, [persons, searchTerm]);

  // 🔹 Filtrage maisons archivées selon projet
  const filteredHomes = useMemo(() => {
    return homes.filter(h => !searchProject || h.projectId?._id === searchProject);
  }, [homes, searchProject]);

  // 🔹 Pagination locataires
  const indexOfLastItem = currentPage * itemsPerPage;
  const indexOfFirstItem = indexOfLastItem - itemsPerPage;
  const currentPersons = filteredPersons.slice(indexOfFirstItem, indexOfLastItem);
  const totalPages = Math.ceil(filteredPersons.length / itemsPerPage);

  return (
    <div>
      <Navbar />
      <Toaster position="top-right" reverseOrder={false} />

      <div className="saas-container">
        <div className="saas-card">
          <nav aria-label="breadcrumb" className="breadcrumb-custom">
            <ol>
              <li><Link to="/Accueil">Accueil</Link></li>
              <li className="active"><i className="fa-solid fa-box-archive"></i> Mes archives</li>
            </ol>
          </nav>

          <div className="header-actions">
            <h2><i className="fa-solid fa-box-archive"></i> Mes archives</h2>
          </div>

          {/* Filtres */}
          <div className="filter-section">
            <select
              className="select-field"
              value={searchProject}
              onChange={(e) => { setSearchProject(e.target.value); setCurrentPage(1); }}
            >
              <option value="">-- Sélectionner un projet --</option>
              {projects.map((p) => (
                <option key={p._id} value={p._id}>{p.name}</option>
              ))}
            </select>

            {searchProject && (
              <input
                type="text"
                className="search-input"
                placeholder="Rechercher un locataire..."
                value={searchTerm}
                onChange={(e) => { setSearchTerm(e.target.value); setCurrentPage(1); }}
              />
            )}
          </div>

          {!searchProject ? (
            <p style={{ textAlign: "center", marginTop: "20px" }}>
              Veuillez sélectionner un projet pour afficher les archives.
            </p>
          ) : (
            <>
              {/* 🔹 Locataires archivés */}
              <div className="tenant-section">
                <h3>📌 Locataires archivés</h3>
                {loading ? (
                  <Blocks visible={true} height="80" width="100%" ariaLabel="loading" />
                ) : (
                  <div className="table-responsive">
                    <table className="table">
                      <thead>
                        <tr>
                          <th>Nom & Prénom(s)</th>
                          <th>Contacts</th>
                          <th>Bien</th>
                          <th>Statut</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {currentPersons.length === 0 ? (
                          <tr><td colSpan="5" style={{ textAlign: "center" }}>Aucun locataire trouvé</td></tr>
                        ) : (
                          currentPersons.map((person) => (
                            <tr key={person._id}>
                              <td>{person.personId?.name} {person.personId?.lastname}</td>
                              <td>{person.personId?.tel}</td>
                              <td>{person.homeId?.categorie || "N/A"}</td>
                              <td><span className="badge badge-archived">Archivé</span></td>
                              <td>
                                <Link to={`/detailArchivedUser/${person._id}`}>
                                  <button className="btn-details">Détails</button>
                                </Link>
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

              {/* 🔹 Maisons archivées */}
              <div className="tenant-section">
                <h3>🏠 Maisons archivées</h3>
                {loading ? (
                  <Blocks visible={true} height="80" width="100%" ariaLabel="loading" />
                ) : (
                  <div className="table-responsive">
                    <table className="table">
                      <thead>
                        <tr>
                          <th>Nom</th>
                          <th>Adresse</th>
                          <th>Catégorie</th>
                          <th>Projet</th>
                          <th>Statut</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filteredHomes.length === 0 ? (
                          <tr><td colSpan="6" style={{ textAlign: "center" }}>Aucune maison archivée</td></tr>
                        ) : (
                          filteredHomes.map((home) => (
                            <tr key={home._id}>
                              <td>{home.nameHome || "N/A"}</td>
                              <td>{home.addressHome || "N/A"}</td>
                              <td>{home.categorie || "N/A"}</td>
                              <td>{home.projectId?.name || "N/A"}</td>
                              <td><span className="badge badge-archived">Archivé</span></td>
                              <td>
                                <Link to={`/detailArchivedHome/${home._id}`}>
                                  <button className="btn-details">Détails</button>
                                </Link>
                              </td>
                            </tr>
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

              {/* Pagination */}
              {totalPages > 1 && (
                <div className="pagination-section">
                  <button onClick={() => setCurrentPage(p => Math.max(p - 1, 1))} disabled={currentPage === 1}>◀</button>
                  <span>{currentPage} / {totalPages}</span>
                  <button onClick={() => setCurrentPage(p => Math.min(p + 1, totalPages))} disabled={currentPage === totalPages}>▶</button>
                </div>
              )}
            </>
          )}
        </div>
      </div>

      <PermissionModal
        show={showPermissionModal}
        onClose={() => setShowPermissionModal(false)}
        title="Accès refusé"
        message="Vous n'êtes pas autorisé à accéder aux archives."
      />

      <Footer />
      <Toaster position="top-right" reverseOrder={false} />

      {/* CSS inchangé */}
      <style>{`
        .saas-container { padding: 2rem; background: #f8fafc; min-height: 100vh; }
        .saas-card { background: #fff; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); padding: 2rem; }
        .breadcrumb-custom ol { display: flex; gap: .5rem; list-style: none; padding: 0; }
        .breadcrumb-custom li { font-size: .9rem; }
        .breadcrumb-custom .active { color: #2563eb; font-weight: bold; }
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .filter-section { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .search-input, .select-field { padding: .5rem 1rem; border-radius: 6px; border: 1px solid #e5e7eb; }
        .tenant-section { margin-bottom: 2rem; }
        .tenant-section h3 { margin-bottom: 1rem; font-size: 1.2rem; color: #111827; }
        .table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .table th, .table td { padding: .6rem; border: 1px solid #e5e7eb; text-align: center; }
        .table th { background: #f1f5f9; }
        .btn-details { padding: .3rem .6rem; border: none; border-radius: 6px; background: #2563eb; color: #fff; cursor: pointer; }
        .btn-details:hover { background: #1e40af; }
        .badge-archived { background: #ef4444; color: #fff; padding: .2rem .6rem; border-radius: 12px; font-size: 12px; }
        .pagination { margin-top: 1rem; display: flex; gap: .3rem; justify-content: center; }
        .pagination button { padding: .4rem .8rem; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; cursor: pointer; }
        .pagination button.active { background: #2563eb; color: #fff; border-color: #2563eb; }
      `}</style>
    </div>
  );
}


// src/contexts/UserContext.jsx
import React, { createContext, useContext, useState, useEffect, useRef } from "react";
import { toast } from "react-hot-toast";

const SESSION_DURATION = 60 * 60 * 1000; // 1 heure
const WARNING_DURATION = 60 * 1000; // 1 minute avant la fin

const UserContext = createContext();

export function UserProvider({ children }) {
  const [user, setUser] = useState(() => {
    try {
      const storedUser = localStorage.getItem("user");
      return storedUser ? JSON.parse(storedUser) : null;
    } catch (err) {
      console.error("Erreur lecture localStorage:", err);
      return null;
    }
  });

  const [showLogoutModal, setShowLogoutModal] = useState(false);
  const [showSessionWarning, setShowSessionWarning] = useState(false);
  const [countdown, setCountdown] = useState(60);

  const countdownInterval = useRef(null);
  const logoutTimeout = useRef(null);
  const warningTimeout = useRef(null);
  const lastActivity = useRef(Date.now());

  // ✅ Sauvegarde auto dans localStorage
  useEffect(() => {
    if (user) localStorage.setItem("user", JSON.stringify(user));
    else localStorage.removeItem("user");
  }, [user]);

  // ✅ Connexion
  const login = (userData) => {
    if (!userData || !userData._id)
      return console.error("ID utilisateur manquant !");
    const userWithSession = {
      ...userData,
      id: userData._id,
      isAdmin: userData.role === "admin",
      userId: userData.role !== "admin" ? userData._id : null,
      adminId:
        userData.role === "admin"
          ? userData._id
          : userData.adminId || null,
      token: userData.token || null,
    };
    setUser(userWithSession);
    startSessionTimer(); // 🔹 Démarre la session
  };

  // ✅ Déconnexion
  const logout = () => {
    clearSessionTimers();
    setUser(null);
    localStorage.removeItem("user");
    localStorage.removeItem("token");
    setShowLogoutModal(false);
    setShowSessionWarning(false);
    toast.success("Déconnexion réussie 👋");
  };

  // ✅ Ouvrir / Fermer la modal
  const openLogoutModal = () => setShowLogoutModal(true);
  const closeLogoutModal = () => setShowLogoutModal(false);

  // ✅ Gestion du timer de session
  const startSessionTimer = () => {
    clearSessionTimers();

    // Timer d’avertissement à 59e minute
    warningTimeout.current = setTimeout(() => {
      setShowSessionWarning(true);
      setCountdown(60);

      countdownInterval.current = setInterval(() => {
        setCountdown((prev) => {
          if (prev <= 1) {
            clearInterval(countdownInterval.current);
            logout();
            toast.error("Session expirée ⏱️");
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    }, SESSION_DURATION - WARNING_DURATION);

    // Timer de déconnexion à 1h
    logoutTimeout.current = setTimeout(() => {
      logout();
      toast.error("Votre session a expiré automatiquement ⏱️");
    }, SESSION_DURATION);
  };

  const clearSessionTimers = () => {
    if (logoutTimeout.current) clearTimeout(logoutTimeout.current);
    if (warningTimeout.current) clearTimeout(warningTimeout.current);
    if (countdownInterval.current) clearInterval(countdownInterval.current);
  };

  // ✅ Gestion de l'activité utilisateur
  const handleUserActivity = () => {
    const now = Date.now();
    const inactiveTime = now - lastActivity.current;
    lastActivity.current = now;

    // Si utilisateur actif et session en cours → on relance le timer
    if (inactiveTime > 5000) {
      // on réinitialise seulement si ça fait plus de 5s sans activité
      if (user) {
        setShowSessionWarning(false);
        startSessionTimer();
      }
    }
  };

  // ✅ Écoute des événements d'activité
  useEffect(() => {
    if (user) {
      const events = ["mousemove", "keydown", "click", "scroll", "touchstart"];
      events.forEach((event) =>
        window.addEventListener(event, handleUserActivity)
      );
      startSessionTimer();

      return () => {
        clearSessionTimers();
        events.forEach((event) =>
          window.removeEventListener(event, handleUserActivity)
        );
      };
    }
  }, [user]);

  // ✅ Login Handler global
  const loginHandler = async (role, emailOrUsername, password, navigate) => {
    try {
      const endpoint =
        role === "admin"
          ? "http://localhost:4000/admin/login"
          : "http://localhost:4000/user/login";

      const body =
        role === "admin"
          ? { email: emailOrUsername.trim(), password: password.trim(), role }
          : { username: emailOrUsername.trim(), password: password.trim(), role };

      const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const data = await response.json();

      if (!response.ok) {
        toast.error(data.message || "Identifiants incorrects");
        return null;
      }

      if (!data.user || !data.token) {
        toast.error("Impossible de récupérer les informations de l'utilisateur");
        return null;
      }

      login({ ...data.user, token: data.token, role });
      localStorage.setItem("token", data.token);

      toast.success(
        `Bienvenue, ${data.user.fullname || data.user.name || "Utilisateur"} 👋`
      );
      navigate(role === "admin" ? "/administrator" : "/");
      return data.user;
    } catch (error) {
      console.error("Erreur serveur :", error);
      toast.error("Erreur serveur, réessayez plus tard");
      return null;
    }
  };

  return (
    <UserContext.Provider
      value={{
        user,
        setUser,
        login,
        logout,
        loginHandler,
        showLogoutModal,
        openLogoutModal,
        closeLogoutModal,
      }}
    >
      {children}

      {/* ✅ Modal déconnexion manuelle */}
      {showLogoutModal && (
        <div className="logout-modal-overlay" onClick={closeLogoutModal}>
          <div className="logout-modal" onClick={(e) => e.stopPropagation()}>
            <h3>Voulez-vous vraiment vous déconnecter ?</h3>
            <div className="logout-actions">
              <button className="btn-confirm" onClick={logout}>
                Oui, déconnecter
              </button>
              <button className="btn-cancel" onClick={closeLogoutModal}>
                Annuler
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ⚠️ Modal d’avertissement session */}
      {showSessionWarning && (
        <div className="logout-modal-overlay">
          <div className="logout-modal">
            <h3>Votre session expirera dans {countdown} seconde(s)</h3>
            <p>Souhaitez-vous prolonger votre session ?</p>
            <div className="logout-actions">
              <button
                className="btn-confirm"
                onClick={() => {
                  setShowSessionWarning(false);
                  startSessionTimer();
                  toast.success("Session prolongée ⏳");
                }}
              >
                Oui, prolonger
              </button>
              <button className="btn-cancel" onClick={logout}>
                Déconnecter maintenant
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ✅ Styles */}
      <style jsx>{`
        .logout-modal-overlay {
          position: fixed;
          top: 0; left: 0;
          width: 100%; height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex; justify-content: center; align-items: center;
          z-index: 2000;
        }
        .logout-modal {
          background: #fff;
          padding: 2rem;
          border-radius: 10px;
          text-align: center;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
          max-width: 350px;
          animation: pop 0.3s ease-in-out;
        }
        @keyframes pop {
          0% { transform: scale(0.8); opacity: 0; }
          100% { transform: scale(1); opacity: 1; }
        }
        .logout-modal h3 {
          margin-bottom: 1rem;
          font-size: 1.1rem;
          color: #333;
        }
        .logout-modal p {
          font-size: 0.9rem;
          margin-bottom: 1.5rem;
          color: #555;
        }
        .logout-actions {
          display: flex;
          justify-content: space-between;
          gap: 1rem;
        }
        .btn-confirm {
          background: #2563eb;
          color: #fff;
          border: none;
          padding: 0.6rem 1.2rem;
          border-radius: 6px;
          cursor: pointer;
          font-weight: 500;
        }
        .btn-confirm:hover { background: #1d4ed8; }
        .btn-cancel {
          background: #e5e7eb;
          border: none;
          padding: 0.6rem 1.2rem;
          border-radius: 6px;
          cursor: pointer;
          font-weight: 500;
        }
        .btn-cancel:hover { background: #d1d5db; }
      `}</style>
    </UserContext.Provider>
  );
}

export function useUserContext() {
  const context = useContext(UserContext);
  if (!context)
    throw new Error("useUserContext doit être utilisé dans un UserProvider");
  return context;
}




import { useState, useEffect } from "react";
import { useNavigate, useLocation, Link, useParams } from "react-router-dom";
import { useUserContext } from "../contexts/UserContext";
import { toast, Toaster } from "react-hot-toast";

export default function Home() {
  const navigate = useNavigate();
  const location = useLocation();
  const { token: activationToken } = useParams();
  const { login } = useUserContext();

  // === Mode affiché : login ou register ===
  const [mode, setMode] = useState("login");

  // === États communs ===
  const [loading, setLoading] = useState(false);
  const [showHelp, setShowHelp] = useState(false);

  // === Login states ===
  const [emailOrUsername, setEmailOrUsername] = useState("");
  const [password, setPassword] = useState("");
  const [role, setRole] = useState("admin");

  // === Register states ===
  const [email, setEmail] = useState("");
  const [fullname, setFullname] = useState("");
  const [username, setUsername] = useState("");
  const [address, setAddress] = useState("");
  const [number, setNumber] = useState("");
  const [password2, setPassword2] = useState("");
  const [subscriptionType, setSubscriptionType] = useState("mensuel");

  // === Reset password ===
  const [resetToken, setResetToken] = useState(null);
  const [newPassword, setNewPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [showResetPassword, setShowResetPassword] = useState(false);

  // === Activation & Reset token depuis URL ===
  useEffect(() => {
    if (activationToken) {
      fetch(`https://backend-ged-immo.onrender.com/confirm/${activationToken}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            toast.success("✅ Compte activé avec succès !");
            navigate("/");
          } else {
            toast.error(data.message || "Erreur d’activation");
          }
        })
        .catch(console.error);
    }

    const params = new URLSearchParams(location.search);
    const tokenFromQuery = params.get("token");
    if (tokenFromQuery) {
      setResetToken(tokenFromQuery);
      setShowResetPassword(true);
    }
  }, [activationToken, location, navigate]);

  // === LOGIN ===
  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      const endpoint =
        role === "admin"
          ? "https://backend-ged-immo.onrender.com/admin/login"
          : "https://backend-ged-immo.onrender.com/user/login";

      const body =
        role === "admin"
          ? { email: emailOrUsername.trim(), password: password.trim(), role }
          : { username: emailOrUsername.trim(), password: password.trim(), role };

      const response = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const data = await response.json();
      if (!response.ok) return toast.error(data.message || "Identifiants incorrects");
      if (!data.user || !data.token)
        return toast.error("Impossible de récupérer les informations utilisateur");

      const userData = {
        ...data.user,
        token: data.token,
        isAdmin: role === "admin",
        adminId: role === "admin" ? data.user._id : data.user.adminId || null,
        userId: role !== "admin" ? data.user._id : null,
      };

      login(userData);
      toast.success(`Bienvenue, ${data.user.fullname || "Utilisateur"} 👋`);
      navigate(role === "admin" ? "/users" : "/users");
    } catch (err) {
      console.error(err);
      toast.error("Erreur serveur");
    } finally {
      setLoading(false);
    }
  };

  // === REGISTER ===
  const handleRegister = async (e) => {
    e.preventDefault();
    setLoading(true);
    if (password !== password2)
      return toast.error("Les mots de passe ne correspondent pas"), setLoading(false);

    try {
      const res = await fetch("http://localhost:4000/admin/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          fullname,
          username,
          address,
          number,
          email,
          password,
          password2,
          subscriptionType,
        }),
      });
      const data = await res.json();
      if (res.ok) {
        toast.success("Inscription réussie ! Vérifiez votre email ✅");
        setTimeout(() => setMode("login"), 10000);
      } else {
        toast.error(data.message || "Erreur lors de l'inscription");
      }
    } catch (err) {
      console.error(err);
      toast.error("Erreur serveur : " + err.message);
    } finally {
      setLoading(false);
    }
  };

  // === RESET PASSWORD ===
  const handleResetPassword = async () => {
    if (newPassword !== confirmPassword)
      return toast.error("Les mots de passe ne correspondent pas");
    try {
      const res = await fetch(`https://backend-ged-immo.onrender.com/reset-password/${resetToken}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: newPassword }),
      });
      const data = await res.json();
      if (res.ok) {
        toast.success("Mot de passe réinitialisé !");
        setShowResetPassword(false);
        navigate("/");
      } else toast.error(data.message);
    } catch (err) {
      toast.error("Erreur serveur");
    }
  };

  // === UI ===
  return (
    <div style={styles.page}>
      <Toaster position="top-right" />
      <div style={styles.assistHeader}>
        <p><i className="fa-solid fa-phone"></i> Assistance : +225 07 77 88 00 82</p>
        <p>Email : doumbia77fode@gmail.com</p>
        <button style={styles.helpBtn} onClick={() => setShowHelp(true)}>Aide</button>
      </div>

      <div style={styles.authBox}>
        <img src={`${process.env.PUBLIC_URL}/logo4 copie.jpg`} alt="logo" style={styles.logo} />
        <h2 style={styles.title}>GED IMMO</h2>

        {/* === Toggle Login/Register === */}
        <div style={styles.tabContainer}>
          <button
            style={{ ...styles.tabBtn, backgroundColor: mode === "login" ? "#3498db" : "#ccc" }}
            onClick={() => setMode("login")}
          >
            Connexion
          </button>
          <button
            style={{ ...styles.tabBtn, backgroundColor: mode === "register" ? "#3498db" : "#ccc" }}
            onClick={() => setMode("register")}
          >
            Inscription
          </button>
        </div>

        {/* === LOGIN FORM === */}
        {mode === "login" && !showResetPassword && (
          <form onSubmit={handleLogin} style={styles.form}>
            <select value={role} onChange={(e) => setRole(e.target.value)} style={styles.input}>
              <option value="admin">👑 Administrateur</option>
              <option value="manager">🧑‍💼 Manager</option>
              <option value="user">👤 Utilisateur</option>
            </select>
            <input
              type={role === "admin" ? "email" : "text"}
              placeholder={role === "admin" ? "Email" : "Nom d'utilisateur"}
              value={emailOrUsername}
              onChange={(e) => setEmailOrUsername(e.target.value)}
              style={styles.input}
            />
            <input
              type="password"
              placeholder="Mot de passe"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              style={styles.input}
            />
            <button type="submit" style={styles.button}>
              {loading ? "Connexion..." : "Connexion"}
            </button>
          </form>
        )}

        {/* === REGISTER FORM === */}
        {mode === "register" && (
          <form onSubmit={handleRegister} style={styles.form}>
            <input style={styles.input} placeholder="Nom complet" value={fullname} onChange={(e) => setFullname(e.target.value)} />
            <input style={styles.input} placeholder="Nom d'utilisateur" value={username} onChange={(e) => setUsername(e.target.value)} />
            <input style={styles.input} placeholder="Adresse" value={address} onChange={(e) => setAddress(e.target.value)} />
            <input style={styles.input} placeholder="Numéro" value={number} onChange={(e) => setNumber(e.target.value)} />
            <input style={styles.input} placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} />
            <input style={styles.input} type="password" placeholder="Mot de passe" value={password} onChange={(e) => setPassword(e.target.value)} />
            <input style={styles.input} type="password" placeholder="Confirmer mot de passe" value={password2} onChange={(e) => setPassword2(e.target.value)} />
           <select
                  value={subscriptionType}
                  onChange={(e) => setSubscriptionType(e.target.value)}
                  style={styles.input}
                >
                  <option value="gratuit">Gratuit — 3 mois d’essai</option>
                  <option value="standard">Standard — 60 000 FCFA / 6 mois</option>
                  <option value="premium">Premium — 100 000 FCFA / an</option>
                </select>

                <p style={styles.subscriptionInfo}>
                  {subscriptionType === "gratuit" && "🆓 Votre essai gratuit dure 3 mois."}
                  {subscriptionType === "standard" && "📅 Votre abonnement durera 6 mois."}
                  {subscriptionType === "premium" && "💎 Votre abonnement premium durera 1 an."}
                </p>
            <button type="submit" style={styles.button}>
              {loading ? "Inscription..." : "Créer un compte"}
            </button>
          </form>
        )}

        {/* === RESET PASSWORD === */}
        {showResetPassword && (
          <div style={{ marginTop: "20px" }}>
            <h3>Réinitialiser le mot de passe</h3>
            <input
              type="password"
              placeholder="Nouveau mot de passe"
              value={newPassword}
              onChange={(e) => setNewPassword(e.target.value)}
              style={styles.input}
            />
            <input
              type="password"
              placeholder="Confirmer mot de passe"
              value={confirmPassword}
              onChange={(e) => setConfirmPassword(e.target.value)}
              style={styles.input}
            />
            <button style={styles.button} onClick={handleResetPassword}>
              Réinitialiser
            </button>
          </div>
        )}
      </div>

      {/* === Modal Aide === */}
      {showHelp && (
        <div style={styles.modalOverlay} onClick={() => setShowHelp(false)}>
          <div style={styles.modalContent} onClick={(e) => e.stopPropagation()}>
            <h2 style={styles.modalTitle}>💡 Aide & FAQ</h2>
            <p>Suivez ces étapes pour configurer votre compte GED IMMO.</p>
            <button style={styles.closeBtn} onClick={() => setShowHelp(false)}>
              Fermer
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

// === Styles ===
const styles = {
  page: { fontFamily: "'Segoe UI', sans-serif", backgroundColor: "#f2f2f7", minHeight: "100vh", display: "flex", flexDirection: "column", alignItems: "center" },
  assistHeader: { width: "100%", backgroundColor: "#fff", padding: "10px 20px", display: "flex", justifyContent: "space-between", alignItems: "center", boxShadow: "0 2px 6px rgba(0,0,0,0.1)", marginBottom: "30px", flexWrap: "wrap" },
  helpBtn: { backgroundColor: "#3498db", color: "#fff", border: "none", padding: "5px 12px", borderRadius: "5px", cursor: "pointer" },
  authBox: { backgroundColor: "#fff", padding: "40px 30px", borderRadius: "15px", boxShadow: "0 10px 30px rgba(0,0,0,0.1)", maxWidth: "420px", width: "90%", textAlign: "center" },
  logo: { width: "100px", height: "100px", objectFit: "contain", marginBottom: "15px" },
  title: { marginBottom: "15px", color: "#333" },
  tabContainer: { display: "flex", justifyContent: "center", gap: "10px", marginBottom: "20px" },
  tabBtn: { flex: 1, padding: "10px", borderRadius: "8px", border: "none", color: "#fff", cursor: "pointer", fontWeight: "bold" },
  form: { display: "flex", flexDirection: "column", gap: "12px" },
  input: { padding: "12px", borderRadius: "8px", border: "1px solid #ccc", fontSize: "1rem" },
  button: { padding: "12px", borderRadius: "8px", border: "none", backgroundColor: "#3498db", color: "#fff", fontSize: "1rem", cursor: "pointer" },
  modalOverlay: { position: "fixed", top: 0, left: 0, right: 0, bottom: 0, backgroundColor: "rgba(0,0,0,0.5)", display: "flex", justifyContent: "center", alignItems: "center" },
  modalContent: { backgroundColor: "#fff", padding: "30px", borderRadius: "15px", textAlign: "center", width: "90%", maxWidth: "400px" },
  modalTitle: { marginBottom: "10px", fontSize: "1.5rem", color: "#333" },
  closeBtn: { marginTop: "15px", backgroundColor: "#3498db", color: "#fff", padding: "10px 20px", borderRadius: "8px", border: "none", cursor: "pointer" },
};

      {/* Login Box */}
      <div style={styles.loginContainer}>
        <div style={styles.loginBox}>
          <img src={`${process.env.PUBLIC_URL}/logo4 copie.jpg`} alt="logo" style={styles.logo} />
          <h2 style={styles.title}>GED IMMO</h2>

          {!showResetPassword && !showForgotEmail && (
            <form onSubmit={loginHandler} style={styles.form}>
              {/* 🟢 Sélecteur de rôle */}
              <select
                value={role}
                onChange={(e) => setRole(e.target.value)}
                style={styles.input}
              >
                <option value="admin">👑 Administrateur</option>
                <option value="manager">🧑‍💼 Manager</option>
                <option value="user">👤 Utilisateur</option>
              </select>

              {/* 🟢 Champ dynamique (email pour admin, username pour autres) */}
              <input
                type={role === "admin" ? "email" : "text"}
                placeholder={role === "admin" ? "Email" : "Nom d'utilisateur"}
                value={emailOrUsername}
                onChange={(e) => setEmailOrUsername(e.target.value)}
                style={styles.input}
                required
              />
              <input
                type="password"
                placeholder="Mot de passe"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                style={styles.input}
                required
              />
              <button type="submit" style={styles.button} disabled={loading}>
                {loading ? "Connexion..." : "Connexion"}
              </button>
            </form>
          )}

          {!showResetPassword && (
            <div style={styles.linksContainer}>
              <span onClick={() => setShowForgotEmail(true)} style={styles.forgotLink}>
                Mot de passe oublié ?
              </span>
              {role === "admin" && (
                <p>
                  Pas reçu le mail ?{" "}
                  <span onClick={resendLink} style={styles.resendLink}>
                    {resendLoading ? "Envoi..." : "Renvoyer le lien"}
                  </span>
                </p>
              )}
            </div>
          )}

          {/* Reset / Forgot password UI identique */}
          {showForgotEmail && (
            <div style={{ marginTop: "20px" }}>
              <h3 style={{ marginBottom: "10px" }}>📧 Réinitialiser le mot de passe</h3>
              <input
                type="email"
                placeholder="Entrez votre email"
                value={forgotEmail}
                onChange={(e) => setForgotEmail(e.target.value)}
                style={styles.input}
              />
              <div style={{ display: "flex", gap: "10px", marginTop: "10px" }}>
                <button style={styles.button} onClick={handleForgotPassword}>
                  Envoyer le lien
                </button>
                <button
                  style={{ ...styles.button, backgroundColor: "#e74c3c" }}
                  onClick={() => setShowForgotEmail(false)}
                >
                  Annuler
                </button>
              </div>
            </div>
          )}

          {showResetPassword && (
            <div style={{ marginTop: "20px" }}>
              <h3 style={{ marginBottom: "10px" }}>🔑 Réinitialiser votre mot de passe</h3>
              <input
                type="password"
                placeholder="Nouveau mot de passe"
                value={newPassword}
                onChange={(e) => setNewPassword(e.target.value)}
                style={styles.input}
              />
              <input
                type="password"
                placeholder="Confirmer mot de passe"
                value={confirmPassword}
                onChange={(e) => setConfirmPassword(e.target.value)}
                style={styles.input}
              />
              <div style={{ display: "flex", gap: "10px", marginTop: "10px" }}>
                <button style={styles.button} onClick={handleResetPassword}>
                  Réinitialiser
                </button>
                <button
                  style={{ ...styles.button, backgroundColor: "#e74c3c" }}
                  onClick={() => setShowResetPassword(false)}
                >
                  Annuler
                </button>
              </div>
            </div>
          )}

          <div>
            <p style={styles.loginLink}>
              Créer un nouveau compte ?{" "}
              <Link to="/new__inscription" style={styles.link}>
                Inscription
              </Link>
            </p>
          </div>
        </div>
      </div>																							  // --- Renvoyer lien activation ---
 

 j'ai ajouté un nouveau type a mon projet c'est a dire que l'admin pourra créer un projet et comme type magasin 